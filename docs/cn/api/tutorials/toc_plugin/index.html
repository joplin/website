<!DOCTYPE html>
<html lang="en-gb">

<!--

!!! WARNING !!!

This file was auto-generated from readme/api/tutorials/toc_plugin.md and any manual change
made to it will be overwritten. To make a change to this file please modify
the source Markdown file:

https://github.com/laurent22/joplin/blob/dev/readme/api/tutorials/toc_plugin.md

-->

	<head>
		<!-- Google Tag Manager -->
		<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
		new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
		j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
		'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
		})(window,document,'script','dataLayer','GTM-579DTGX');</script>
		<!-- End Google Tag Manager -->		<!-- Monthly/Yearly plan A/B testing -->
		<!--
		<script src="https://www.googleoptimize.com/optimize.js?id=OPT-PW3ZPK3"></script>
		-->

		<!-- Donate button A/B testing -->
		<!--
		<script async src="https://www.googleoptimize.com/optimize.js?id=OPT-PW3ZPK3"></script>
		-->		<meta
			charset="utf-8"
			http-equiv="X-UA-Compatible"
			content="IE=edge,chrome=1"
		/>
		<link rel="icon" href="&#x2F;images/favicon.png" />
		<meta name="viewport" content="width=device-width, initial-scale=1" />
		<meta name="theme-color" content="#000000" />
			<meta name="description" content="This tutorial will guide you through the steps to create a table of content plugin for Joplin. It will display a view next to the current note that will contain links to the sections of a note. It ..." />
			<meta name="twitter:card" content="summary" />
			<meta name="twitter:site" content="@joplinapp" />
			<meta property="og:url" content="https://joplinapp.org/cn/api/tutorials/toc_plugin/index.html" />
			<meta property="og:title" content="Creating a table of content plugin" />
			<meta property="twitter:title" content="Creating a table of content plugin" />
			<meta property="og:description" content="This tutorial will guide you through the steps to create a table of content plugin for Joplin. It will display a view next to the current note that will contain links to the sections of a note. It ..." />
			<meta property="twitter:description" content="This tutorial will guide you through the steps to create a table of content plugin for Joplin. It will display a view next to the current note that will contain links to the sections of a note. It ..." />
		<link rel="alternate" type="application/rss+xml" title="Joplin RSS feed" href="https://joplinapp.org/rss.xml" />		<link
			rel="stylesheet"
			href="&#x2F;css/bootstrap5.0.2.min.css"
			as="style"
		/>
		<link rel="stylesheet" href="/css/fontawesome-all.min.css?h=ecd507b3125edc4d2a03aa6ae5d07da9">
		<link
			href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&display=swap"
			rel="stylesheet"
			as="style"
			media="all"
			onload="this.media='all'; this.onload = null"
		/>
		<link rel="stylesheet" href="/css/site.css?h=4088f5ad58d081586548c9cb79966504" as="style" />
		
		<title>Creating a table of content plugin | Joplin</title>

		<script
			src="&#x2F;js/jquery-3.6.0.min.js"
			rel="preload"
			as="script"
		></script>
	</head>
	<body class="website-env-prod">
		<!-- Google Tag Manager (noscript) -->
		<noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-579DTGX"
		height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
		<!-- End Google Tag Manager (noscript) -->		
		<div class="container-fluid generic-template -page" id="main-container">

				<div class=" navbar-main white-bg" id="nav-section">
					<div class="container">
						<div class="row">
							<div class="col-3">
								<a href="/">
									<img
										src="&#x2F;images/logo-text-blue.svg"
										alt=""
										id="top-logo"
										width="180"
									/>
								</a>
							</div>
							<div class="col-9 text-right d-none d-md-block">
								<a href="https://twitter.com/joplinapp" title="Joplin Twitter feed" class="fw500 twitter-link"><i class="fab fa-twitter"></i></a>								<a href="/news/" class="fw500">News</a>
								<a href="/help/" class="fw500">Help</a>
								<a href="https:&#x2F;&#x2F;discourse.joplinapp.org&#x2F;" class="fw500">Forum</a>
								<a href="/cn/" class="fw500">中文</a>

								<!--
								<div class="dropdown language-switcher">
									<button class="fw500" type="button" id="dropdownMenuButton1" data-bs-toggle="dropdown" aria-expanded="false">
										Language
									</button>
									<ul class="dropdown-menu" aria-labelledby="dropdownMenuButton1">
										<li><a class="dropdown-item" href="#">Action</a></li>
										<li><a class="dropdown-item" href="#">Another action</a></li>
										<li><a class="dropdown-item" href="#">Something else here</a></li>
									</ul>
								</div>
								-->


									<a href="/plans/" class="button-link btn-trans plans-button">Joplin Cloud</a>								<a class="button-link btn-blue sponsor-button" href="/donate">
									<i class="fas fa-heart heart-full"></i><i class="far fa-heart heart-line"></i><span class="sponsor-button-label">&nbsp;Support us</span>
								</a>							</div>
							<div class="col-9 text-right d-block d-md-none navbar-mobile-content">
								<a href="https://twitter.com/joplinapp" title="Joplin Twitter feed" class="fw500 twitter-link"><i class="fab fa-twitter"></i></a>								<a href="/cn/" class="fw500 chinese-page-link">中文</a>
								<a href="/plans/" class="button-link btn-trans plans-button">Joplin Cloud</a>								<a class="button-link btn-blue sponsor-button" href="/donate">
									<i class="fas fa-heart heart-full"></i><i class="far fa-heart heart-line"></i><span class="sponsor-button-label">&nbsp;Support us</span>
								</a>
								<span class="pointer"
									><img
										src="&#x2F;images/mobile-menu-black-open-icon.png"
										id="open-menu-mobile"
										alt=""
								/></span>
								&nbsp;&nbsp;

								<div id="menu-mobile">
									<div>
										<div class="text-right">
											<img
												src="&#x2F;images/close-icon.png"
												alt=""
												class="pointer"
												id="close-menu-mobile"
											/>
										</div>

										<div class="text-center menu-mobile-top">
											<a href="/news/" class="fw500 mobile-menu-link">News</a>
											<a href="/help/" class="fw500 mobile-menu-link">Help</a>
											<a href="https:&#x2F;&#x2F;discourse.joplinapp.org&#x2F;" class="fw500 mobile-menu-link">Forum</a>
										</div>

										<div class="menu-mobile-buttons">
												<a href="/plans/" class="button-link btn-trans plans-button">Joplin Cloud</a>											<a class="button-link btn-blue sponsor-button" href="/donate">
												<i class="fas fa-heart heart-full"></i><i class="far fa-heart heart-line"></i><span class="sponsor-button-label">&nbsp;Support us</span>
											</a>										</div>
									</div>

										<div id="toc-mobile"><div><ul>
<li>
<p>Applications</p>
<ul>
<li><a href="/cn/desktop/">Desktop application</a></li>
<li><a href="/cn/mobile/">Mobile applications</a></li>
<li><a href="/cn/terminal/">Terminal application</a></li>
<li><a href="/cn/clipper/">Web Clipper</a></li>
</ul>
</li>
<li>
<p>Support</p>
<ul>
<li><a href="https://discourse.joplinapp.org">Joplin Forum</a></li>
<li><a href="/cn/markdown/">Markdown Guide</a></li>
<li><a href="/cn/e2ee/">How to enable end-to-end encryption</a></li>
<li><a href="/cn/conflict/">What is a conflict?</a></li>
<li><a href="/cn/debugging/">How to enable debug mode</a></li>
<li><a href="/cn/rich_text_editor/">About the Rich Text editor limitations</a></li>
<li><a href="/cn/external_links/">External links</a></li>
<li><a href="/cn/faq/">FAQ</a></li>
</ul>
</li>
<li>
<p>Joplin Cloud</p>
<ul>
<li><a href="/cn/share_notebook/">Sharing a notebook</a></li>
<li><a href="/cn/publish_note/">Publishing a note</a></li>
<li><a href="/cn/email_to_note/">Email to Note</a></li>
</ul>
</li>
<li>
<p>Joplin API - Get Started</p>
<ul>
<li><a href="/cn/api/overview/">Joplin API Overview</a></li>
<li><a href="/cn/api/get_started/plugins/">Plugin development</a></li>
<li><a href="/cn/api/tutorials/toc_plugin/">Plugin tutorial</a></li>
</ul>
</li>
<li>
<p>Joplin API - References</p>
<ul>
<li><a href="https://joplinapp.org/api/references/plugin_api/classes/joplin.html">Plugin API</a></li>
<li><a href="/cn/api/references/rest_api/">Data API</a></li>
<li><a href="/cn/api/references/plugin_manifest/">Plugin manifest</a></li>
<li><a href="/cn/api/references/plugin_loading_rules/">Plugin loading rules</a></li>
<li><a href="/cn/api/references/plugin_theming/">Plugin theming</a></li>
</ul>
</li>
<li>
<p>Development</p>
<ul>
<li><a href="https://github.com/laurent22/joplin/blob/dev/BUILD.md">How to build the apps</a></li>
<li><a href="/cn/technical_spec/">Writing a technical spec</a></li>
<li><a href="/cn/spec/desktop_styling/">Desktop application styling</a></li>
<li><a href="/cn/spec/history/">Note history spec</a></li>
<li><a href="/cn/spec/sync/">Synchronisation spec</a></li>
<li><a href="/cn/spec/sync_lock/">Sync Lock spec</a></li>
<li><a href="/cn/spec/sync_scroll/">Synchronous Scroll spec</a></li>
<li><a href="/cn/spec/architecture/">Overall Architecture spec</a></li>
<li><a href="/cn/spec/plugins/">Plugin Architecture spec</a></li>
<li><a href="/cn/spec/search_sorting/">Search Sorting spec</a></li>
<li><a href="/cn/spec/e2ee/">E2EE: Technical spec</a></li>
<li><a href="/cn/spec/e2ee/workflow/">E2EE: Workflow</a></li>
<li><a href="/cn/spec/server_file_url_format/">Server: File URL Format</a></li>
<li><a href="/cn/spec/server_delta_sync/">Server: Delta Sync</a></li>
<li><a href="/cn/spec/server_sharing/">Server: Sharing</a></li>
<li><a href="/cn/spec/read_only/">Read-only items</a></li>
</ul>
</li>
<li>
<p>Google Summer of Code 2022</p>
<ul>
<li><a href="/cn/gsoc2022/">Google Summer of Code 2022</a></li>
<li><a href="/cn/gsoc2022/pull_request_guidelines/">How to submit a GSoC pull request</a></li>
<li><a href="/cn/gsoc2022/ideas/">Project Ideas</a></li>
</ul>
</li>
<li>
<p>About</p>
<ul>
<li><a href="/cn/changelog/">Changelog (Desktop App)</a></li>
<li><a href="/cn/changelog_android/">Changelog (Android)</a></li>
<li><a href="/cn/changelog_ios/">Changelog (iOS)</a></li>
<li><a href="/cn/changelog_cli/">Changelog (CLI App)</a></li>
<li><a href="/cn/changelog_server/">Changelog (Server)</a></li>
<li><a href="/cn/principles/">Guiding principles</a></li>
<li><a href="/cn/stats/">Stats</a></li>
<li><a href="https://joplinapp.org/brand">Brand guidelines</a></li>
<li><a href="/cn/donate/">Donate</a></li>
</ul>
</li>
</ul>
</div></div>

									<div class="row">
										<div class="col-12 col-md-12 social-links">
											<a class="social-link-twitter" href="https://twitter.com/joplinapp" title="Joplin Twitter feed"><i class="fab fa-twitter"></i></a>
											<a class="social-link-mastodon" href="https://mastodon.social/@joplinapp" title="Joplin Mastodon feed"><i class="fab fa-mastodon"></i></a>
											<a class="social-link-patreon" href="https://www.patreon.com/joplin" title="Joplin Patreon"><i class="fab fa-patreon"></i></a>
											<a class="social-link-discord" href="https://discord.gg/VSj7AFHvpq" title="Joplin Discord chat"><i class="fab fa-discord"></i></a>
											<a class="social-link-linkedin" href="https://www.linkedin.com/company/joplin" title="Joplin LinkedIn Feed"><i class="fab fa-linkedin"></i></a>
											<a class="social-link-lemmy" href="https://sopuli.xyz/c/joplinapp" title="Joplin Lemmy Community"><i class="fas fa-otter"></i></a>
											<a class="social-link-github" href="https://github.com/laurent22/joplin/" title="Joplin GitHub repository"><i class="fab fa-github"></i></a>
										</div>
									</div>
									
									<div>
										<p class="light-blue mobile-menu-link-bottom text-center">
											Copyright &copy; 2016-2023 Laurent&nbsp;Cozic
											<br/>
											<a href="/privacy/" class="fw500">Privacy Policy</a>
										</p>
									</div>
								</div>
							</div>
						</div>
					</div>
				</div>
			<div class="help-page-container page-toc_plugin">
				<div class="container">
					<div class="row content-wrapper">
						<div id="toc"><div><ul>
<li>
<p>Applications</p>
<ul>
<li><a href="/cn/desktop/">Desktop application</a></li>
<li><a href="/cn/mobile/">Mobile applications</a></li>
<li><a href="/cn/terminal/">Terminal application</a></li>
<li><a href="/cn/clipper/">Web Clipper</a></li>
</ul>
</li>
<li>
<p>Support</p>
<ul>
<li><a href="https://discourse.joplinapp.org">Joplin Forum</a></li>
<li><a href="/cn/markdown/">Markdown Guide</a></li>
<li><a href="/cn/e2ee/">How to enable end-to-end encryption</a></li>
<li><a href="/cn/conflict/">What is a conflict?</a></li>
<li><a href="/cn/debugging/">How to enable debug mode</a></li>
<li><a href="/cn/rich_text_editor/">About the Rich Text editor limitations</a></li>
<li><a href="/cn/external_links/">External links</a></li>
<li><a href="/cn/faq/">FAQ</a></li>
</ul>
</li>
<li>
<p>Joplin Cloud</p>
<ul>
<li><a href="/cn/share_notebook/">Sharing a notebook</a></li>
<li><a href="/cn/publish_note/">Publishing a note</a></li>
<li><a href="/cn/email_to_note/">Email to Note</a></li>
</ul>
</li>
<li>
<p>Joplin API - Get Started</p>
<ul>
<li><a href="/cn/api/overview/">Joplin API Overview</a></li>
<li><a href="/cn/api/get_started/plugins/">Plugin development</a></li>
<li><a href="/cn/api/tutorials/toc_plugin/">Plugin tutorial</a></li>
</ul>
</li>
<li>
<p>Joplin API - References</p>
<ul>
<li><a href="https://joplinapp.org/api/references/plugin_api/classes/joplin.html">Plugin API</a></li>
<li><a href="/cn/api/references/rest_api/">Data API</a></li>
<li><a href="/cn/api/references/plugin_manifest/">Plugin manifest</a></li>
<li><a href="/cn/api/references/plugin_loading_rules/">Plugin loading rules</a></li>
<li><a href="/cn/api/references/plugin_theming/">Plugin theming</a></li>
</ul>
</li>
<li>
<p>Development</p>
<ul>
<li><a href="https://github.com/laurent22/joplin/blob/dev/BUILD.md">How to build the apps</a></li>
<li><a href="/cn/technical_spec/">Writing a technical spec</a></li>
<li><a href="/cn/spec/desktop_styling/">Desktop application styling</a></li>
<li><a href="/cn/spec/history/">Note history spec</a></li>
<li><a href="/cn/spec/sync/">Synchronisation spec</a></li>
<li><a href="/cn/spec/sync_lock/">Sync Lock spec</a></li>
<li><a href="/cn/spec/sync_scroll/">Synchronous Scroll spec</a></li>
<li><a href="/cn/spec/architecture/">Overall Architecture spec</a></li>
<li><a href="/cn/spec/plugins/">Plugin Architecture spec</a></li>
<li><a href="/cn/spec/search_sorting/">Search Sorting spec</a></li>
<li><a href="/cn/spec/e2ee/">E2EE: Technical spec</a></li>
<li><a href="/cn/spec/e2ee/workflow/">E2EE: Workflow</a></li>
<li><a href="/cn/spec/server_file_url_format/">Server: File URL Format</a></li>
<li><a href="/cn/spec/server_delta_sync/">Server: Delta Sync</a></li>
<li><a href="/cn/spec/server_sharing/">Server: Sharing</a></li>
<li><a href="/cn/spec/read_only/">Read-only items</a></li>
</ul>
</li>
<li>
<p>Google Summer of Code 2022</p>
<ul>
<li><a href="/cn/gsoc2022/">Google Summer of Code 2022</a></li>
<li><a href="/cn/gsoc2022/pull_request_guidelines/">How to submit a GSoC pull request</a></li>
<li><a href="/cn/gsoc2022/ideas/">Project Ideas</a></li>
</ul>
</li>
<li>
<p>About</p>
<ul>
<li><a href="/cn/changelog/">Changelog (Desktop App)</a></li>
<li><a href="/cn/changelog_android/">Changelog (Android)</a></li>
<li><a href="/cn/changelog_ios/">Changelog (iOS)</a></li>
<li><a href="/cn/changelog_cli/">Changelog (CLI App)</a></li>
<li><a href="/cn/changelog_server/">Changelog (Server)</a></li>
<li><a href="/cn/principles/">Guiding principles</a></li>
<li><a href="/cn/stats/">Stats</a></li>
<li><a href="https://joplinapp.org/brand">Brand guidelines</a></li>
<li><a href="/cn/donate/">Donate</a></li>
</ul>
</li>
</ul>
</div></div>

						<div class="main-content">
							<div class="alert alert-danger alert-env-dev" role="alert">
								Running in prod mode!
							</div>
							<div class="donate-links">
<p><a href="https://www.paypal.com/donate/?business=E8JMYD2LQ8MMA&amp;no_recurring=0&amp;item_name=I+rely+on+donations+to+maintain+and+improve+the+Joplin+open+source+project.+Thank+you+for+your+help+-+it+makes+a+difference%21&amp;currency_code=EUR"><img src="https://raw.githubusercontent.com/laurent22/joplin/dev/Assets/WebsiteAssets/images/badges/Donate-PayPal-green.svg" alt="Donate using PayPal"></a> <a href="https://github.com/sponsors/laurent22/"><img src="https://raw.githubusercontent.com/laurent22/joplin/dev/Assets/WebsiteAssets/images/badges/GitHub-Badge.svg" alt="Sponsor on GitHub"></a> <a href="https://www.patreon.com/joplin"><img src="https://raw.githubusercontent.com/laurent22/joplin/dev/Assets/WebsiteAssets/images/badges/Patreon-Badge.svg" alt="Become a patron"></a> <a href="https://joplinapp.org/donate/#donations"><img src="https://raw.githubusercontent.com/laurent22/joplin/dev/Assets/WebsiteAssets/images/badges/Donate-IBAN.svg" alt="Donate using IBAN"></a></p>
</div>
<h1>Creating a table of content plugin<a name="creating-a-table-of-content-plugin" href="#creating-a-table-of-content-plugin" class="heading-anchor">🔗</a></h1>
<p>This tutorial will guide you through the steps to create a table of content plugin for Joplin. It will display a view next to the current note that will contain links to the sections of a note. It will be possible to click on one of the header to jump to the relevant section.</p>
<p>Through this tutorial you will learn about several aspect of the Joplin API, including:</p>
<ul>
<li>The plugin API</li>
<li>How to create a webview</li>
<li>How to listen to changes in the user interface</li>
</ul>
<h2>Setting up your environment<a name="setting-up-your-environment" href="#setting-up-your-environment" class="heading-anchor">🔗</a></h2>
<p>Before getting any further, make sure your environment is setup correctly as described in the <a href="/cn/api/get_started/plugins/">Get Started guide</a>.</p>
<h2>Registering the plugin<a name="registering-the-plugin" href="#registering-the-plugin" class="heading-anchor">🔗</a></h2>
<p>All plugins must <a href="https://joplinapp.org/api/references/plugin_api/classes/joplinplugins.html">register themselves</a> and declare what events they can handle. To do so, open <code>src/index.ts</code> and register the plugin as below. We'll also need to run some initialisation code when the plugin starts, so add the <code>onStart()</code> event handler too:</p>
<pre><code class="language-typescript">// Import the Joplin API
import joplin from 'api';

// Register the plugin
joplin.plugins.register({

	// Run initialisation code in the onStart event handler
	// Note that due to the plugin multi-process architecture, you should
	// always assume that all function calls and event handlers are async.
	onStart: async function() {
		console.info('TOC plugin started!');
	},

});
</code></pre>
<p>If you now build the plugin and try to run it in Joplin, you should see the message <code>TOC plugin started!</code> in the dev console.</p>
<h2>Getting the current note<a name="getting-the-current-note" href="#getting-the-current-note" class="heading-anchor">🔗</a></h2>
<p>In order to create the table of content, you will need to access the content of the currently selected note, and you will need to refresh the TOC every time the note changes. All this can be done using the <a href="https://joplinapp.org/api/references/plugin_api/classes/joplinworkspace.html">workspace API</a>, which provides information about the active content being edited.</p>
<p>So within the <code>onStart()</code> event handler, add the following:</p>
<pre><code class="language-typescript">joplin.plugins.register({

	onStart: async function() {

		// Later, this is where you'll want to update the TOC
		async function updateTocView() {
			// Get the current note from the workspace.
			const note = await joplin.workspace.selectedNote();

			// Keep in mind that it can be `null` if nothing is currently selected!
			if (note) {
				console.info('Note content has changed! New note is:', note);
			} else {
				console.info('No note is selected');
			}
		}

		// This event will be triggered when the user selects a different note
		await joplin.workspace.onNoteSelectionChange(() =&gt; {
			updateTocView();
		});

		// This event will be triggered when the content of the note changes
		// as you also want to update the TOC in this case.
		await joplin.workspace.onNoteChange(() =&gt; {
			updateTocView();
		});

		// Also update the TOC when the plugin starts
		updateTocView();
	},

});
</code></pre>
<p>Try the above and you should see in the console the event handler being called every time a new note is opened, or whenever the note content changes.</p>
<h2>Getting the note sections and slugs<a name="getting-the-note-sections-and-slugs" href="#getting-the-note-sections-and-slugs" class="heading-anchor">🔗</a></h2>
<p>Now that you have the current note, you'll need to extract the headers from that note in order to build the TOC from it. Since the note content is plain Markdown, there are several ways to do so, such as using a Markdown parser, but for now a quick and dirty solution is to get all the lines that start with any number of  <code>#</code> followed by a space. Any such line should be a header.</p>
<p>The function below, which you can copy anywhere in your file, will use this method and return an array of headers, with the text and level (H1, H2, etc.) of header:</p>
<pre><code class="language-typescript">function noteHeaders(noteBody:string) {
	const headers = [];
	const lines = noteBody.split('\n');
	for (const line of lines) {
		const match = line.match(/cn/^(#+)\s(.*)*/);
		if (!match) continue;
		headers.push({
			level: match[1].length,
			text: match[2],
		});
	}
	return headers;
}
</code></pre>
<p>Then call this function from your event handler:</p>
<pre><code class="language-typescript">joplin.plugins.register({

	onStart: async function() {

		async function updateTocView() {
			const note = await joplin.workspace.selectedNote();

			if (note) {
				const headers = noteHeaders(note.body);
				console.info('The note has the following headers', headers);
			} else {
				console.info('No note is selected');
			}
		}

		// ...
	},

});
</code></pre>
<p>Later you will also need a way to generate the slug for each header. A slug is an identifier which is used to link to a particular header. Essentially a header text like &quot;My Header&quot; is converted to &quot;my-header&quot;. And if there's already a slug with that name, a number is appended to it. Without going into too much details, you will need the &quot;slug&quot; package to generate this for you, so install it using <code>npm i -s 'git+https://github.com/laurent22/uslug.git#emoji-support'</code> from the root of your plugin directory (Note: you can also install the &quot;uslug&quot; package on its own, but it won't have emoji support).</p>
<p>Then this is the function you will need for Joplin, so copy it somewhere in your file:</p>
<pre><code class="language-typescript">const uslug = require('@joplin/fork-uslug');

let slugs = {};

function headerSlug(headerText) {
	const s = uslug(headerText);
	let num = slugs[s] ? slugs[s] : 1;
	const output = [s];
	if (num &gt; 1) output.push(num);
	slugs[s] = num + 1;
	return output.join('-');
}
</code></pre>
<p>And you will need a utility function to escape HTML. There are many packages to do this but for now you can simply use this:</p>
<pre><code class="language-typescript">// From https://stackoverflow.com/a/6234804/561309
function escapeHtml(unsafe:string) {
	return unsafe
		.replace(/cn/&amp;/g, &quot;&amp;amp;&quot;)
		.replace(/cn/&lt;/g, &quot;&amp;lt;&quot;)
		.replace(/cn/&gt;/g, &quot;&amp;gt;&quot;)
		.replace(/cn/&quot;/g, &quot;&amp;quot;&quot;)
		.replace(/cn/'/g, &quot;&amp;#039;&quot;);
}
</code></pre>
<p>Again try to run the plugin and if you select a note with multiple headers, you should see the header list in the console.</p>
<h2>Creating a webview<a name="creating-a-webview" href="#creating-a-webview" class="heading-anchor">🔗</a></h2>
<p>In order to display the TOC in Joplin, you will need a <a href="https://joplinapp.org/api/references/plugin_api/classes/joplinviewspanels.html">webview panel</a>. Panels are a simple way to add custom content to the UI using HTML/CSS and JavaScript. First you would create the panel object and get back a view handler. Using this handler, you can set various properties such as the HTML content.</p>
<p>Here's how it could be done:</p>
<pre><code class="language-typescript">joplin.plugins.register({

	onStart: async function() {
		// Create the panel object
		const panel = await joplin.views.panels.create('panel_1');

		// Set some initial content while the TOC is being created
		await joplin.views.panels.setHtml(panel, 'Loading...');

		async function updateTocView() {
			const note = await joplin.workspace.selectedNote();
			slugs = {}; // Reset the slugs

			if (note) {
				const headers = noteHeaders(note.body);

				// First create the HTML for each header:
				const itemHtml = [];
				for (const header of headers) {
					const slug = headerSlug(header.text);

					// - We indent each header based on header.level.
					//
					// - The slug will be needed later on once we implement clicking on a header.
					//   We assign it to a &quot;data&quot; attribute, which can then be easily retrieved from JavaScript
					//
					// - Also make sure you escape the text before inserting it in the HTML to avoid XSS attacks
					//   and rendering issues. For this use the `escapeHtml()` function you've added earlier.
					itemHtml.push(`
						&lt;p class=&quot;toc-item&quot; style=&quot;padding-left:${(header.level - 1) * 15}px&quot;&gt;
							&lt;a class=&quot;toc-item-link&quot; href=&quot;#&quot; data-slug=&quot;${escapeHtml(slug)}&quot;&gt;
								${escapeHtml(header.text)}
							&lt;/a&gt;
						&lt;/p&gt;
					`);
				}

				// Finally, insert all the headers in a container and set the webview HTML:
				await joplin.views.panels.setHtml(panel, `
					&lt;div class=&quot;container&quot;&gt;
						${itemHtml.join('\n')}
					&lt;/div&gt;
				`);
			} else {
				await joplin.views.panels.setHtml(panel, 'Please select a note to view the table of content');
			}
		}

		// ...
	},

});
</code></pre>
<p>Now run the plugin again and you should see the TOC dynamically updating as you change notes.</p>
<h2>Styling the view<a name="styling-the-view" href="#styling-the-view" class="heading-anchor">🔗</a></h2>
<p>In order to better integrate the TOC to Joplin, you might want to style it using CSS. To do so, first add a <code>webview.css</code> file next to <code>index.ts</code>, then you will need to let Joplin know about this file. This is done using the <code>addScript()</code> function (which is also used to add JavaScript files as we'll see later), like so:</p>
<pre><code class="language-typescript">const panel = await joplin.views.panels.create('panel_1');
 // Add the CSS file to the view, right after it has been created:
await joplin.views.panels.addScript(panel, './webview.css');
</code></pre>
<p>This file is just a plain CSS file you can use to style your view. Additionally, you can access from there a number of theme variables, which you can use to better integrate the view to the UI. For example, using these variables you can use a dark background in dark mode, and a light one in light mode.</p>
<p>The CSS file below would give the view the correct font color and family, and the right background colour:</p>
<pre><code class="language-css">/* In webview.css */

.container {
	background-color: var(--joplin-background-color);
	color: var(--joplin-color);
	font-size: var(--joplin-font-size);
	font-family: var(--joplin-font-family);
}

.toc-item a {
	color: var(--joplin-color);
	text-decoration: none;
}
</code></pre>
<p>Try the plugin and the styling should be improved. You may also try to switch to dark or light mode and see the style being updated.</p>
<h2>Making the webview interactive<a name="making-the-webview-interactive" href="#making-the-webview-interactive" class="heading-anchor">🔗</a></h2>
<p>The next step is to make the TOC interactive so that when the user clicks on a link, the note is scrolled to right header. This can be done using an external JavaScript file that will handle the click events. As for the CSS file, create a <code>webview.js</code> file next to <code>index.ts</code>, then add the script to the webview:</p>
<pre><code class="language-typescript">// In index.ts
const panel = await joplin.views.panels.create('panel_1');
await joplin.views.panels.addScript(panel, './webview.css');
await joplin.views.panels.addScript(panel, './webview.js'); // Add the JS file
</code></pre>
<p>To check that everything's working, let's create a simple event handler that display the header slug when clicked:</p>
<pre><code class="language-javascript">// In webview.js

// There are many ways to listen to click events, you can even use
// something like jQuery or React. This is how it can be done using
// plain JavaScript:
document.addEventListener('click', event =&gt; {
	const element = event.target;
	// If a TOC header has been clicked:
	if (element.className === 'toc-item-link') {
		// Get the slug and display it:
		const slug = element.dataset.slug;
		console.info('Clicked header slug: ' + slug);
	}
});
</code></pre>
<p>If everything works well, you should now see the slug in the console whenever you click on a header link. The next step will be to use that slug to scroll to the right header.</p>
<h2>Passing messages between the webview and the plugin<a name="passing-messages-between-the-webview-and-the-plugin" href="#passing-messages-between-the-webview-and-the-plugin" class="heading-anchor">🔗</a></h2>
<p>For security reason, webviews run within their own sandbox (iframe) and thus do not have access to the Joplin API. You can however send messages to and from the webview to the plugin, and you can call the Joplin API from the plugin.</p>
<p>From within a webview, you have access to the webviewApi object, which among others has a <code>postMessage()</code> function you can use to send a message to the plugin. Let's use this to post the slug info to the plugin:</p>
<p>Change <code>webview.js</code> like so:</p>
<pre><code class="language-javascript">document.addEventListener('click', event =&gt; {
	const element = event.target;
	if (element.className === 'toc-item-link') {
		// Post the message and slug info back to the plugin:
		webviewApi.postMessage({
			name: 'scrollToHash',
			hash: element.dataset.slug,
		});
	}
});
</code></pre>
<p>Then from the plugin, in <code>src/index.ts</code>, you can listen to this message using the <code>onMessage()</code> handler. Then from this handler, you can call the <code>scrollToHash</code> command and pass it the slug (or hash).</p>
<pre><code class="language-typescript">joplin.plugins.register({
	onStart: async function() {
		const panel = await joplin.views.panels.create('panel_1');

		// ...

		await joplin.views.panels.onMessage(panel, (message) =&gt; {
			if (message.name === 'scrollToHash') {
				// As the name says, the scrollToHash command makes the note scroll
				// to the provided hash.
				joplin.commands.execute('scrollToHash', message.hash)
			}
		});

		// ...
	}

	// ...
</code></pre>
<p>And that's it! If you run this code you should now have a fully functional TOC. The full source code is available there:</p>
<p><a href="https://github.com/laurent22/joplin/tree/dev/packages/app-cli/tests/support/plugins/toc/">https://github.com/laurent22/joplin/tree/dev/packages/app-cli/tests/support/plugins/toc/</a></p>
<p>Various improvements can be made such as improving the styling, making the header collapsible, etc. but that tutorial should provide the basic building blocks to do so. You might also want to check the <a href="https://joplinapp.org/api/references/plugin_api/classes/joplin.html">plugin API</a> for further information or head to the <a href="https://discourse.joplinapp.org/c/development/6">development forum</a> for support.</p>

								<div class="bottom-links">
										<a class="bottom-link" href="https://github.com/laurent22/joplin/blob/dev/readme/api/tutorials/toc_plugin.md">
											<i class="fab fa-github"></i> Improve this doc
										</a>
								</div>
						</div>
					</div>
				</div>
			</div>

			
			<footer class="darkblue-bg">
				<div class="container">
					<div class="row">
						<div class="col-12 col-md-12 social-links">
							<a class="social-link-twitter" href="https://twitter.com/joplinapp" title="Joplin Twitter feed"><i class="fab fa-twitter"></i></a>
							<a class="social-link-mastodon" href="https://mastodon.social/@joplinapp" title="Joplin Mastodon feed"><i class="fab fa-mastodon"></i></a>
							<a class="social-link-patreon" href="https://www.patreon.com/joplin" title="Joplin Patreon"><i class="fab fa-patreon"></i></a>
							<a class="social-link-discord" href="https://discord.gg/VSj7AFHvpq" title="Joplin Discord chat"><i class="fab fa-discord"></i></a>
							<a class="social-link-linkedin" href="https://www.linkedin.com/company/joplin" title="Joplin LinkedIn Feed"><i class="fab fa-linkedin"></i></a>
							<a class="social-link-lemmy" href="https://sopuli.xyz/c/joplinapp" title="Joplin Lemmy Community"><i class="fas fa-otter"></i></a>
							<a class="social-link-github" href="https://github.com/laurent22/joplin/" title="Joplin GitHub repository"><i class="fab fa-github"></i></a>
						</div>
					</div>

					<div class="row bottom-links-row">
						<div class="col-12 col-md-6">
							<p class="text-center-sm">Copyright &copy; 2016-2023 Laurent Cozic</p>
						</div>
						<div class="col-12 col-md-6">
							<p class="text-right text-center-sm right-links">
								<span class="footer-right">
									<a href="/privacy/">Privacy Policy</a>
								</span>
							</p>
						</div>
					</div>
				</div>
			</footer>		</div>

		<script
			src="&#x2F;js/bootstrap5.0.2.bundle.min.js"
			rel="preload"
			as="script"
		></script>
		<script src="/js/script.js?h=b1cc510889690b9703c87eafe6c3e8e0"></script>

		<script>
			if (window.location.hostname !== 'localhost') {
				(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
				(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
				m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
				})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
				ga('create', 'UA-103586105-1', 'auto');
				ga('send', 'pageview');
			}
		</script>	</body>
</html>
